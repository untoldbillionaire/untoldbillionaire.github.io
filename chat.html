<!doctype html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>untoldbillionaire.com - Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background-color: powderblue; font-family: Georgia, serif; margin: 0; padding: 0; display: flex; }
    .sidebar { width: 250px; background: #fff; padding: 10px; border-right: 1px solid #ccc; }
    .sidebar h3 { margin-top: 0; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar li { margin: 5px 0; display: flex; align-items: center; justify-content: space-between; }
    .sidebar img { width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; }
    .sidebar button { padding: 4px 8px; border: none; border-radius: 4px; background: #4285F4; color: #fff; cursor: pointer; margin-left: 5px; }
    .sidebar button:hover { background: #357AE8; }

    .main { flex: 1; }
    .auth-bar { text-align: center; margin: 20px; }
    .auth-bar button { padding: 8px 12px; border: none; border-radius: 6px; background: #4285F4; color: #fff; cursor: pointer; }
    .auth-bar button:hover { background: #357AE8; }
    .auth-bar img { width: 60px; height: 60px; border-radius: 50%; margin-top: 10px; border: 2px solid #333; cursor: pointer; }

    .chat-container { max-width: 600px; margin: 20px auto; background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #messages { height: 400px; overflow-y: auto; border-bottom: 1px solid #ccc; padding: 10px; }
    .message { margin: 10px 0; padding: 8px; border-radius: 6px; background: #f1f1f1; }
    .message img, .message video { max-width: 100%; border-radius: 6px; }
    .chat-input { display: flex; gap: 10px; margin-top: 10px; }
    .chat-input input[type="text"] { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .chat-input button { padding: 8px 12px; border: none; border-radius: 6px; background: #333; color: #fff; cursor: pointer; }
    .chat-input button:hover { background: #555; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>All Users</h3>
    <ul id="userList"></ul>
    <h3>Your Friends</h3>
    <ul id="friendList"></ul>
  </div>

  <div class="main">
    <div class="auth-bar">
      <button id="loginBtn">Sign in with Google</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
      <p id="userInfo"></p>
      <img id="profilePic" src="default-avatar.png" alt="Profile Picture">
      <input type="file" id="profileUpload" accept="image/*" style="display:none;">
    </div>

    <div class="chat-container">
      <div id="messages"></div>
      <div class="chat-input">
        <input type="text" id="messageText" placeholder="Type a message...">
        <input type="file" id="fileInput" accept="image/*,video/*">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, addDoc, getDoc, onSnapshot, serverTimestamp, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    // ðŸ”¹ Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");
    const userList = document.getElementById("userList");
    const friendList = document.getElementById("friendList");
    const profilePic = document.getElementById("profilePic");
    const profileUpload = document.getElementById("profileUpload");
    const messagesDiv = document.getElementById("messages");
    const sendBtn = document.getElementById("sendBtn");
    const messageText = document.getElementById("messageText");
    const fileInput = document.getElementById("fileInput");

    let currentUser = null;
    let selectedFriendId = null;

    // Google Sign-In
    const provider = new GoogleAuthProvider();
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        userInfo.textContent = "Logged in as: " + (user.displayName || user.email);

        // Save user profile
        await setDoc(doc(db, "users", user.uid), {
          displayName: user.displayName || user.email,
          email: user.email,
          photoURL: user.photoURL || "default-avatar.png"
        }, { merge: true });

        profilePic.src = user.photoURL || "default-avatar.png";

        loadUsers();
        loadFriends();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        userInfo.textContent = "";
        userList.innerHTML = "";
        friendList.innerHTML = "";
        messagesDiv.innerHTML = "";
        profilePic.src = "default-avatar.png";
      }
    });

    // Profile picture upload
    profilePic.addEventListener("click", () => {
      if (currentUser) profileUpload.click();
    });

    profileUpload.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (file && currentUser) {
        const storageRef = ref(storage, "profilePics/" + currentUser.uid);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        await setDoc(doc(db, "users", currentUser.uid), { photoURL: url }, { merge: true });
        profilePic.src = url;
      }
    });

    // Load all users
    function loadUsers() {
      onSnapshot(collection(db, "users"), (snapshot) => {
        userList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const u = docSnap.data();
          if (docSnap.id !== currentUser.uid) {
            const li = document.createElement("li");
            li.innerHTML = `<img src="${u.photoURL || 'default-avatar.png'}"> ${u.displayName}`;
            
            const chatBtn = document.createElement("button");
            chatBtn.textContent = "Chat";
            chatBtn.onclick = () => {
              selectedFriendId = docSnap.id;
              loadMessages();
            };

            const addBtn = document.createElement("button");
            addBtn.textContent = "Add Friend";
            addBtn.onclick = () => addFriend(currentUser.uid, docSnap.id);
addBtn.textContent = "Add Friend"; 
}});
</script>
</body>
</html>
